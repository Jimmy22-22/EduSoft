@page "/tarea-detalle/{TareaId:int}"

@layout LayoutMaestro
@using EduSoft.Data
@using EduSoft.Services
@inject ClaseService ClaseService
@inject TareaEstudianteService TareaEstudianteService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<h2 class="tarea-titulo">@Tarea?.Titulo</h2>

@if (Tarea != null)
{
    <div class="tarea-detalle-box">
        <p><strong>Descripción:</strong> @Tarea.Descripcion</p>
        <p><strong>Fecha de Entrega:</strong> @Tarea.FechaEntrega.ToString("dd MMM yyyy")</p>

        @{
            string? linkFinal = null;
            if (!string.IsNullOrWhiteSpace(Tarea?.Link))
            {
                linkFinal = Tarea.Link.StartsWith("http://") || Tarea.Link.StartsWith("https://")
                ? Tarea.Link
                : $"https://{Tarea.Link}";
            }
        }

        @if (!string.IsNullOrWhiteSpace(linkFinal))
        {
            <p><strong>Enlace:</strong> <a href="@linkFinal" target="_blank">@linkFinal</a></p>
        }

        @if (Tarea.ArchivoNombre != null && Tarea.ArchivoContenido != null)
        {
            <p>
                <strong>Archivo:</strong>
                <button class="descargar-btn" @onclick="DescargarOVisualizar">
                    <i class="fas fa-file-alt"></i> Abrir @Tarea.ArchivoNombre
                </button>
            </p>
        }

        <button class="btn-volver" @onclick="VolverAClase">
            <i class="fas fa-arrow-left"></i> Volver a la clase
        </button>
    </div>

    <hr />

    <h3 class="entregas-titulo"><i class="fas fa-user-check"></i> Entregas de Estudiantes</h3>
    @if (Entregas.Count > 0)
    {
        @foreach (var entrega in Entregas)
        {
            <div class="entrega-card">
                <p><strong>Estudiante:</strong> @entrega.Usuario.Nombre</p>
                <p><strong>Fecha de Entrega:</strong> @entrega.FechaEntrega.ToString("dd MMM yyyy HH:mm")</p>

                @if (!string.IsNullOrEmpty(entrega.Comentario))
                {
                    <p><strong>Comentario:</strong> @entrega.Comentario</p>
                }
                @if (!string.IsNullOrEmpty(entrega.Link))
                {
                    string linkEntrega = entrega.Link.StartsWith("http") ? entrega.Link : $"https://{entrega.Link}";
                    <p><strong>Enlace:</strong> <a href="@linkEntrega" target="_blank">@linkEntrega</a></p>
                }
                @if (!string.IsNullOrEmpty(entrega.ArchivoNombre))
                {
                    <button class="descargar-btn" @onclick="() => DescargarOVisualizarEntrega(entrega.ArchivoNombre, entrega.ArchivoContenido)">
                        <i class="fas fa-file-download"></i> Ver/Descargar @entrega.ArchivoNombre
                    </button>
                }
                <textarea class="input-textarea" placeholder="Retroalimentación" @bind="entrega.Retroalimentacion"></textarea>
                <input class="input-nota" type="number" step="0.1" min="0" max="100" @bind="entrega.Nota" placeholder="Nota (0-100)" />
                <button class="btn-guardar" @onclick="() => GuardarRetroalimentacion(entrega)"><i class="fas fa-save"></i> Guardar</button>
            </div>
        }
    }
    else
    {
        <p class="no-data">Aún no hay entregas.</p>
    }
}
else
{
    <p class="no-data">Tarea no encontrada.</p>
}

<style>
    .tarea-titulo {
        color: #1e88e5;
        text-align: center;
        margin-top: 20px;
        font-size: 2.2rem;
        font-weight: bold;
        letter-spacing: 0.5px;
    }

    .tarea-detalle-box {
        background: #ffffff;
        padding: 25px;
        max-width: 700px;
        margin: 30px auto;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border-left: 6px solid #1e88e5;
    }

    .btn-volver, .btn-guardar {
        margin-top: 20px;
        background: #1976d2;
        color: white;
        padding: 10px 25px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s ease;
    }

        .btn-volver:hover, .btn-guardar:hover {
            background: #1565c0;
        }

    .descargar-btn {
        background: #43a047;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s ease;
    }

        .descargar-btn:hover {
            background: #388e3c;
        }

    .entrega-card {
        background: #f5f5f5;
        padding: 20px;
        margin: 20px auto;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        max-width: 750px;
    }

    .input-textarea, .input-nota {
        width: 100%;
        padding: 10px;
        margin-top: 12px;
        border-radius: 8px;
        border: 1px solid #bbb;
        font-size: 0.95rem;
    }

    .entregas-titulo {
        text-align: center;
        color: #1565c0;
        margin-top: 40px;
        margin-bottom: 20px;
        font-size: 1.6rem;
        font-weight: 700;
    }

    .no-data {
        text-align: center;
        margin-top: 40px;
        color: #999;
        font-size: 1.1rem;
        font-style: italic;
    }
</style>

@code {
    [Parameter] public int TareaId { get; set; }
    private Tarea? Tarea;
    private List<EntregaTareaEstudiante> Entregas = new();

    protected override async Task OnInitializedAsync()
    {
        Tarea = await ClaseService.GetTareaPorIdAsync(TareaId);
        if (Tarea != null)
        {
            Entregas = await TareaEstudianteService.ObtenerEntregasPorTareaAsync(Tarea.Id);
        }
    }

    private async Task DescargarOVisualizar()
    {
        if (Tarea?.ArchivoContenido != null && Tarea.ArchivoNombre != null)
        {
            var mime = ObtenerMimeType(Tarea.ArchivoNombre);
            using var stream = new MemoryStream(Tarea.ArchivoContenido);
            using var dotNetStream = new DotNetStreamReference(stream);

            if (EsPreviewable(Tarea.ArchivoNombre))
            {
                await JS.InvokeVoidAsync("previewFileFromStream", mime, dotNetStream);
            }
            else
            {
                await JS.InvokeVoidAsync("downloadFileFromStream", Tarea.ArchivoNombre, mime, dotNetStream);
            }
        }
    }

    private async Task DescargarOVisualizarEntrega(string nombreArchivo, byte[] contenido)
    {
        var mime = ObtenerMimeType(nombreArchivo);
        using var stream = new MemoryStream(contenido);
        using var dotNetStream = new DotNetStreamReference(stream);

        if (EsPreviewable(nombreArchivo))
        {
            await JS.InvokeVoidAsync("previewFileFromStream", mime, dotNetStream);
        }
        else
        {
            await JS.InvokeVoidAsync("downloadFileFromStream", nombreArchivo, mime, dotNetStream);
        }
    }

    private bool EsPreviewable(string nombre)
    {
        var ext = Path.GetExtension(nombre)?.ToLower();
        return ext is ".pdf" or ".jpg" or ".jpeg" or ".png" or ".gif";
    }

    private string ObtenerMimeType(string nombreArchivo)
    {
        var ext = Path.GetExtension(nombreArchivo)?.ToLower() ?? "";
        return ext switch
        {
            ".pdf" => "application/pdf",
            ".doc" => "application/msword",
            ".docx" => "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            ".xls" => "application/vnd.ms-excel",
            ".xlsx" => "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            ".png" => "image/png",
            ".jpg" or ".jpeg" => "image/jpeg",
            ".gif" => "image/gif",
            ".txt" => "text/plain",
            _ => "application/octet-stream"
        };
    }

    private async Task GuardarRetroalimentacion(EntregaTareaEstudiante entrega)
    {
        await TareaEstudianteService.ActualizarRetroalimentacionYNotaAsync(entrega);
    }

    private void VolverAClase()
    {
        if (Tarea != null)
            Navigation.NavigateTo($"/clase-maestro/{Tarea.ClaseId}");
    }
}
